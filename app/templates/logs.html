<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Logs - HiveMatrix Helm</title>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="container">
        <div class="card u-mb-3">
            <div class="card__header">
                <div style="display: flex; align-items: center; gap: 1.5rem;">
                    <h1 class="card__title" style="margin: 0;">System Logs</h1>
                    <div class="logs-status">
                        <span class="status-dot" id="liveStatus"></span>
                        <span id="statusText">Connecting...</span>
                    </div>
                </div>
                <div class="card__header-actions">
                    <button class="btn btn--primary" onclick="clearLogs()">
                        <span class="btn__label">
                            <i data-lucide="trash-2" class="btn__icon"></i>
                            Clear
                        </span>
                    </button>
                    <button class="btn btn--primary" onclick="toggleLive()" id="liveToggle">
                        <span class="btn__label">
                            <i data-lucide="pause" class="btn__icon" id="liveToggleIcon"></i>
                            <span id="liveToggleText">Pause</span>
                        </span>
                    </button>
                    <button class="btn btn--primary" onclick="navigateTo('/')">
                        <span class="btn__label">
                            <i data-lucide="arrow-left" class="btn__icon"></i>
                            Back to Dashboard
                        </span>
                    </button>
                </div>
            </div>
            <div class="card__body">
                <div class="logs-filters" id="filtersPanel">
                    <div class="filter-group">
                        <label>Service</label>
                        <select id="serviceFilter" onchange="applyFilters()">
                            <option value="">All Services</option>
                            {% for service_name in services.keys() %}
                            <option value="{{ service_name }}">{{ service_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Level</label>
                        <select id="levelFilter" onchange="applyFilters()">
                            <option value="">All Levels</option>
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                            <option value="CRITICAL">CRITICAL</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Search</label>
                        <input type="text" id="searchFilter" placeholder="Search messages..." oninput="applyFilters()">
                    </div>
                    <div class="filter-group filter-group--checkbox">
                        <label>Auto-scroll</label>
                        <input type="checkbox" id="autoScroll" checked>
                    </div>
                </div>

                <div class="logs-viewer" id="logsViewer">
                    <div class="logs-empty" id="emptyState">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                            <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"></path>
                        </svg>
                        <p>No logs yet. Waiting for events...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        let isLive = true;
        let logs = [];
        let lastLogId = 0;
        let filters = {
            service: '',
            level: '',
            search: ''
        };

        function getBasePath() {
            const path = window.location.pathname;
            if (path.startsWith('/helm/')) {
                return '/helm';
            }
            return '';
        }

        function navigateTo(path) {
            const basePath = getBasePath();
            window.location.href = basePath + path;
        }

        function toggleLive() {
            isLive = !isLive;
            const btn = document.getElementById('liveToggleText');
            const icon = document.getElementById('liveToggleIcon');
            const status = document.getElementById('liveStatus');

            btn.textContent = isLive ? 'Pause' : 'Resume';
            icon.setAttribute('data-lucide', isLive ? 'pause' : 'play');
            lucide.createIcons(); // Re-render icons

            status.className = 'status-dot ' + (isLive ? 'live' : 'paused');
            document.getElementById('statusText').textContent = isLive ? 'Live' : 'Paused';

            if (isLive) {
                fetchLogs();
            }
        }

        function clearLogs() {
            logs = [];
            lastLogId = 0;
            const viewer = document.getElementById('logsViewer');
            viewer.querySelectorAll('.log-entry').forEach(el => el.remove());
            document.getElementById('emptyState').style.display = 'flex';
        }

        function applyFilters() {
            filters.service = document.getElementById('serviceFilter').value;
            filters.level = document.getElementById('levelFilter').value;
            filters.search = document.getElementById('searchFilter').value.toLowerCase();

            // Re-render all logs with new filters
            const viewer = document.getElementById('logsViewer');
            viewer.querySelectorAll('.log-entry').forEach(el => el.remove());
            logs.forEach(log => appendLogEntry(log));
        }

        function matchesFilters(log) {
            if (filters.service && log.service_name !== filters.service) return false;
            if (filters.level && log.level !== filters.level) return false;
            if (filters.search && !log.message.toLowerCase().includes(filters.search)) return false;
            return true;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour12: false });
        }

        function appendLogEntry(log) {
            if (!matchesFilters(log)) return;

            const viewer = document.getElementById('logsViewer');
            const emptyState = document.getElementById('emptyState');
            const autoScroll = document.getElementById('autoScroll').checked;

            emptyState.style.display = 'none';

            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.dataset.logId = log.id;
            entry.innerHTML = `
                <span class="log-time">${formatTime(log.timestamp)}</span>
                <span class="log-service">${escapeHtml(log.service_name)}</span>
                <span class="log-level ${log.level}">${log.level}</span>
                <span class="log-message">${escapeHtml(log.message)}</span>
                ${log.user_id ? `<span class="log-meta">${escapeHtml(log.user_id)}</span>` : ''}
            `;
            viewer.appendChild(entry);

            if (autoScroll) {
                viewer.scrollTop = viewer.scrollHeight;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function fetchLogs() {
            if (!isLive) return;

            try {
                const basePath = getBasePath();
                const response = await fetch(`${basePath}/api/logs?limit=100`);

                if (!response.ok) throw new Error('Failed to fetch logs');

                const data = await response.json();
                const newLogs = data.logs || [];

                // Only process new logs (those with ID > lastLogId)
                const unseenLogs = newLogs.filter(log => log.id > lastLogId);

                if (unseenLogs.length > 0) {
                    // Sort by ID to ensure correct order
                    unseenLogs.sort((a, b) => a.id - b.id);

                    unseenLogs.forEach(log => {
                        logs.push(log);
                        appendLogEntry(log);
                        lastLogId = Math.max(lastLogId, log.id);
                    });

                    // Keep only last 1000 logs in memory to prevent memory issues
                    if (logs.length > 1000) {
                        const toRemove = logs.length - 1000;
                        logs.splice(0, toRemove);

                        // Remove old entries from DOM
                        const viewer = document.getElementById('logsViewer');
                        const entries = viewer.querySelectorAll('.log-entry');
                        for (let i = 0; i < toRemove && i < entries.length; i++) {
                            entries[i].remove();
                        }
                    }
                }

                const status = document.getElementById('liveStatus');
                status.className = 'status-dot live';
                document.getElementById('statusText').textContent = 'Live';

            } catch (error) {
                console.error('Error fetching logs:', error);
                const status = document.getElementById('liveStatus');
                status.className = 'status-dot error';
                document.getElementById('statusText').textContent = 'Error';
            }
        }

        // Poll for new logs every 2 seconds
        setInterval(() => {
            if (isLive) {
                fetchLogs();
            }
        }, 2000);

        // Initial setup
        window.addEventListener('load', () => {
            lucide.createIcons();
            fetchLogs();
        });
    </script>
</body>
</html>
