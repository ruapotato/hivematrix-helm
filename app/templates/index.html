<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helm - HiveMatrix Service Manager</title>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="container">
        <div class="card u-mb-3">
            <div class="card__header">
                <h1 class="card__title">Helm - Service Manager</h1>
            </div>
            <div class="card__body">
                <p class="u-mb-3">Monitor and manage all HiveMatrix services, view logs, and configure security settings.</p>
                <p class="u-mb-3">Welcome, <strong>{{ user.name }}</strong> ({{ user.permission_level }})</p>

                <div class="dashboard-grid dashboard-grid--three-col">
                    {% set service_order = ['keycloak', 'core', 'nexus', 'helm', 'codex', 'brainhair', 'knowledgetree', 'ledger'] %}
                    {% for service_name in service_order %}
                    {% if service_name in statuses %}
                    {% set status = statuses[service_name] %}
                    <a href="#" onclick="navigateTo('/service/{{ service_name }}'); return false;" class="dashboard-card" data-service="{{ service_name }}">
                        <div class="dashboard-card__icon">
                            {% if service_name == 'keycloak' %}
                                <i data-lucide="key"></i>
                            {% elif service_name == 'helm' %}
                                <i data-lucide="anchor"></i>
                            {% elif service_name == 'core' %}
                                <i data-lucide="shield"></i>
                            {% elif service_name == 'nexus' %}
                                <i data-lucide="network"></i>
                            {% elif service_name == 'codex' %}
                                <i data-lucide="database"></i>
                            {% elif service_name == 'brainhair' %}
                                <i data-lucide="brain"></i>
                            {% elif service_name == 'knowledgetree' %}
                                <i data-lucide="tree-deciduous"></i>
                            {% elif service_name == 'ledger' %}
                                <i data-lucide="receipt"></i>
                            {% else %}
                                <i data-lucide="server"></i>
                            {% endif %}
                        </div>
                        <div class="dashboard-card__content">
                            <h2 class="dashboard-card__title">{{ service_name }}</h2>
                            <div class="dashboard-card__meta">
                                <span class="status-text status-text--{{ 'success' if status.status == 'running' else 'danger' }} service-status">
                                    {{ status.status }}
                                </span>
                                <span class="status-text status-text--{{ 'success' if status.health == 'healthy' else 'warning' if status.health == 'degraded' else 'danger' }} service-health">
                                    {{ status.health }}
                                </span>
                            </div>
                        </div>
                    </a>
                    {% endif %}
                    {% endfor %}

                    {# Display any services not in the predefined order #}
                    {% for service_name, status in statuses.items() %}
                    {% if service_name not in service_order %}
                    <a href="#" onclick="navigateTo('/service/{{ service_name }}'); return false;" class="dashboard-card" data-service="{{ service_name }}">
                        <div class="dashboard-card__icon">
                            <i data-lucide="server"></i>
                        </div>
                        <div class="dashboard-card__content">
                            <h2 class="dashboard-card__title">{{ service_name }}</h2>
                            <div class="dashboard-card__meta">
                                <span class="status-text status-text--{{ 'success' if status.status == 'running' else 'danger' }} service-status">
                                    {{ status.status }}
                                </span>
                                <span class="status-text status-text--{{ 'success' if status.health == 'healthy' else 'warning' if status.health == 'degraded' else 'danger' }} service-health">
                                    {{ status.health }}
                                </span>
                            </div>
                        </div>
                    </a>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card__header">
                <h2 class="card__title">Settings</h2>
            </div>
            <div class="card__body">
                <!-- Security Warning Banner -->
                <div id="security-banner" class="security-banner u-mb-3">
                    <h3 id="security-banner-title" class="security-banner__title">‚ö†Ô∏è Security Alert</h3>
                    <p id="security-banner-message"></p>
                    <a href="#" onclick="navigateTo('/security'); return false;" class="btn btn--danger">
                        <span class="btn__label">
                            <i data-lucide="lock" class="btn__icon"></i>
                            View Security Audit
                        </span>
                    </a>
                </div>

                <div class="dashboard-grid dashboard-grid--three-col">
                    <a href="#" onclick="navigateTo('/security'); return false;" class="dashboard-card">
                        <div class="dashboard-card__icon">
                            <i data-lucide="lock"></i>
                        </div>
                        <div class="dashboard-card__content">
                            <h2 class="dashboard-card__title">Security Audit</h2>
                        </div>
                    </a>

                    <a href="#" onclick="navigateTo('/logs'); return false;" class="dashboard-card">
                        <div class="dashboard-card__icon">
                            <i data-lucide="scroll-text"></i>
                        </div>
                        <div class="dashboard-card__content">
                            <h2 class="dashboard-card__title">System Logs</h2>
                        </div>
                    </a>

                    <a href="#" onclick="navigateTo('/metrics'); return false;" class="dashboard-card">
                        <div class="dashboard-card__icon">
                            <i data-lucide="bar-chart"></i>
                        </div>
                        <div class="dashboard-card__content">
                            <h2 class="dashboard-card__title">Metrics</h2>
                        </div>
                    </a>

                    {% if user.permission_level == 'admin' %}
                    <a href="#" onclick="navigateTo('/modules'); return false;" class="dashboard-card">
                        <div class="dashboard-card__icon">
                            <i data-lucide="package"></i>
                        </div>
                        <div class="dashboard-card__content">
                            <h2 class="dashboard-card__title">Manage Modules</h2>
                        </div>
                    </a>

                    <a href="#" onclick="navigateTo('/users'); return false;" class="dashboard-card">
                        <div class="dashboard-card__icon">
                            <i data-lucide="user"></i>
                        </div>
                        <div class="dashboard-card__content">
                            <h2 class="dashboard-card__title">Manage Users</h2>
                        </div>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get the base path (in case we're behind a proxy like Nexus)
        function getBasePath() {
            // If we're at /helm/, use that as base, otherwise use root
            const path = window.location.pathname;
            if (path.startsWith('/helm/')) {
                return '/helm';
            }
            return '';
        }

        function navigateTo(path) {
            const basePath = getBasePath();
            window.location.href = basePath + path;
        }

        // Check security status on load
        function checkSecurityStatus() {
            const basePath = getBasePath();
            fetch(`${basePath}/api/security/audit`)
                .then(response => response.json())
                .then(data => {
                    const banner = document.getElementById('security-banner');
                    const title = document.getElementById('security-banner-title');
                    const message = document.getElementById('security-banner-message');

                    if (data.exposed_services && data.exposed_services.length > 0) {
                        banner.classList.add('security-banner--critical', 'is-visible');
                        title.textContent = 'üî¥ CRITICAL SECURITY ALERT';
                        message.textContent = `${data.exposed_services.length} service(s) are exposed to the network and can be accessed externally. This is a security risk!`;
                    } else if (data.firewall_required && data.firewall_required.length > 0) {
                        banner.classList.add('is-visible');
                        title.textContent = '‚ö†Ô∏è Firewall Protection Recommended';
                        message.textContent = `${data.firewall_required.length} service(s) should be protected by firewall. This is normal for Java apps like Keycloak. Click to apply firewall rules.`;
                    } else if (data.severity === 'low') {
                        banner.classList.add('is-visible');
                        title.textContent = '‚ö†Ô∏è Security Warning';
                        message.textContent = 'Minor security concerns detected. Review the security audit for details.';
                    }
                    // If firewall is active and protecting services, no banner needed
                })
                .catch(error => {
                    console.error('Failed to check security status:', error);
                });
        }

        // Run security check on page load
        window.addEventListener('load', () => {
            checkSecurityStatus();
            // Initialize Lucide icons
            lucide.createIcons();
        });

        // Update dashboard data without page reload
        function updateDashboard() {
            const basePath = getBasePath();
            fetch(`${basePath}/api/dashboard/status`)
                .then(response => response.json())
                .then(data => {
                    updateServiceCards(data.statuses);
                })
                .catch(error => {
                    console.error('Failed to update dashboard:', error);
                });
        }

        function updateServiceCards(statuses) {
            const grid = document.querySelector('.dashboard-grid');
            if (!grid) return;

            // Update each card
            Object.keys(statuses).forEach(serviceName => {
                const status = statuses[serviceName];
                const card = grid.querySelector(`[data-service="${serviceName}"]`);
                if (!card) return; // Service not in grid yet, would need full reload

                // Update status text
                const statusText = card.querySelector('.service-status');
                if (statusText) {
                    statusText.className = `status-text status-text--${status.status === 'running' ? 'success' : 'danger'} service-status`;
                    statusText.textContent = status.status;
                }

                // Update health text
                const healthText = card.querySelector('.service-health');
                if (healthText) {
                    let statusClass = 'status-text service-health';
                    if (status.health === 'healthy') statusClass += ' status-text--success';
                    else if (status.health === 'degraded') statusClass += ' status-text--warning';
                    else statusClass += ' status-text--danger';
                    healthText.className = statusClass;
                    healthText.textContent = status.health;
                }
            });
        }

        // Poll for updates every 5 seconds
        setInterval(updateDashboard, 5000);
    </script>
</body>
</html>
