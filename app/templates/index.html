<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helm - HiveMatrix Service Manager</title>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="container">
        <div class="card u-mb-3">
            <div class="card__header">
                <h1 class="card__title">HiveMatrix Helm</h1>
            </div>
            <div class="card__body">
                <p class="u-m-0">Welcome, <strong>{{ user.name }}</strong> ({{ user.permission_level }})</p>
            </div>
        </div>

        <!-- Security Warning Banner -->
        <div id="security-banner" class="security-banner u-mb-3">
            <h3 id="security-banner-title" class="security-banner__title">⚠️ Security Alert</h3>
            <p id="security-banner-message"></p>
            <a href="#" onclick="navigateTo('/security'); return false;" class="btn btn--danger">
                <span class="btn__label">
                    <i data-lucide="lock" class="btn__icon"></i>
                    View Security Audit
                </span>
            </a>
        </div>

        <div class="card u-mb-3">
            <div class="card__header">
                <h2 class="card__title">Quick Links</h2>
            </div>
            <div class="card__body">
                <div class="btn-group">
                    <a href="#" onclick="navigateTo('/security'); return false;" class="btn btn--primary">
                        <span class="btn__label">
                            <i data-lucide="lock" class="btn__icon"></i>
                            Security Audit
                        </span>
                    </a>
                    <a href="#" onclick="navigateTo('/logs'); return false;" class="btn btn--primary">
                        <span class="btn__label">
                            <i data-lucide="scroll-text" class="btn__icon"></i>
                            View All Logs
                        </span>
                    </a>
                    <a href="#" onclick="navigateTo('/metrics'); return false;" class="btn btn--primary">
                        <span class="btn__label">
                            <i data-lucide="bar-chart" class="btn__icon"></i>
                            View Metrics
                        </span>
                    </a>
                    {% if user.permission_level == 'admin' %}
                    <a href="#" onclick="navigateTo('/modules'); return false;" class="btn btn--primary">
                        <span class="btn__label">
                            <i data-lucide="package" class="btn__icon"></i>
                            Manage Modules
                        </span>
                    </a>
                    <a href="#" onclick="navigateTo('/users'); return false;" class="btn btn--primary">
                        <span class="btn__label">
                            <i data-lucide="user" class="btn__icon"></i>
                            Manage Users
                        </span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card__header">
                <h2 class="card__title">Services Overview</h2>
            </div>
            <div class="card__body">
                <table>
                    <thead>
                        <tr>
                            <th>Service</th>
                            <th>Status</th>
                            <th>Health</th>
                            <th>Port</th>
                            <th>PID</th>
                            <th>CPU %</th>
                            <th>Memory (MB)</th>
                            <th>Logs (1h)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for service_name, status in statuses.items() %}
                        <tr data-service="{{ service_name }}">
                            <td>
                                <a href="#" onclick="navigateTo('/service/{{ service_name }}'); return false;">{{ service_name }}</a>
                            </td>
                            <td>
                                <span class="status-text status-text--{{ 'success' if status.status == 'running' else 'danger' }}">
                                    {{ status.status }}
                                </span>
                            </td>
                            <td>
                                <span class="status-text status-text--{{ 'success' if status.health == 'healthy' else 'warning' if status.health == 'degraded' else 'danger' }}">
                                    {{ status.health }}
                                </span>
                            </td>
                            <td>{{ status.configured_port or 'N/A' }}</td>
                            <td class="pid-cell">{{ status.pid or '-' }}</td>
                            <td class="cpu-cell">
                                {% if status.cpu_percent is not none %}
                                    {{ "%.1f"|format(status.cpu_percent) }}%
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="mem-cell">
                                {% if status.memory_mb is not none %}
                                    {{ "%.1f"|format(status.memory_mb) }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% set stats = log_stats.get(service_name, {}) %}
                                {% if stats %}
                                    <span class="log-stats">
                                        {% if stats.get('ERROR', 0) > 0 %}
                                            <span class="status-text status-text--danger">E: {{ stats.get('ERROR', 0) }}</span>
                                        {% endif %}
                                        {% if stats.get('WARNING', 0) > 0 %}
                                            <span class="status-text status-text--warning">W: {{ stats.get('WARNING', 0) }}</span>
                                        {% endif %}
                                        {% if stats.get('INFO', 0) > 0 %}
                                            <span class="status-text status-text--info">I: {{ stats.get('INFO', 0) }}</span>
                                        {% endif %}
                                    </span>
                                {% else %}
                                    <span class="log-stats">-</span>
                                {% endif %}
                            </td>
                            <td class="actions-cell" data-is-admin="{{ 'true' if user.permission_level == 'admin' else 'false' }}">
                                {% if user.permission_level == 'admin' %}
                                    <div class="action-icons">
                                        {% if status.status == 'running' %}
                                            <span class="icon-wrapper" data-tooltip="Stop" onclick="controlService('{{ service_name }}', 'stop')">
                                                <i data-lucide="stop-circle" class="action-icon action-icon--danger"></i>
                                            </span>
                                            <span class="icon-wrapper" data-tooltip="Restart" onclick="controlService('{{ service_name }}', 'restart')">
                                                <i data-lucide="refresh-cw" class="action-icon action-icon--neutral"></i>
                                            </span>
                                        {% else %}
                                            <span class="icon-wrapper" data-tooltip="Start" onclick="controlService('{{ service_name }}', 'start')">
                                                <i data-lucide="play-circle" class="action-icon action-icon--success"></i>
                                            </span>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <em>Admin only</em>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Get the base path (in case we're behind a proxy like Nexus)
        function getBasePath() {
            // If we're at /helm/, use that as base, otherwise use root
            const path = window.location.pathname;
            if (path.startsWith('/helm/')) {
                return '/helm';
            }
            return '';
        }

        function navigateTo(path) {
            const basePath = getBasePath();
            window.location.href = basePath + path;
        }

        function controlService(serviceName, action) {
            if (!confirm(`Are you sure you want to ${action} ${serviceName}?`)) {
                return;
            }

            const basePath = getBasePath();
            fetch(`${basePath}/api/services/${serviceName}/${action}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + getAuthToken()
                },
                body: JSON.stringify({ mode: 'development' })
            })
            .then(response => response.json())
            .then(data => {
                // Show brief success message
                const message = data.message || 'Action completed';
                alert(message);
                // Immediately update dashboard to show new status
                updateDashboard();
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        }

        function getAuthToken() {
            // This would normally come from the session or cookie
            // For now, we assume Nexus handles auth via session
            return '';
        }

        // Check security status on load
        function checkSecurityStatus() {
            const basePath = getBasePath();
            fetch(`${basePath}/api/security/audit`)
                .then(response => response.json())
                .then(data => {
                    const banner = document.getElementById('security-banner');
                    const title = document.getElementById('security-banner-title');
                    const message = document.getElementById('security-banner-message');

                    if (data.exposed_services && data.exposed_services.length > 0) {
                        banner.classList.add('security-banner--critical', 'is-visible');
                        title.textContent = '🔴 CRITICAL SECURITY ALERT';
                        message.textContent = `${data.exposed_services.length} service(s) are exposed to the network and can be accessed externally. This is a security risk!`;
                    } else if (data.firewall_required && data.firewall_required.length > 0) {
                        banner.classList.add('is-visible');
                        title.textContent = '⚠️ Firewall Protection Recommended';
                        message.textContent = `${data.firewall_required.length} service(s) should be protected by firewall. This is normal for Java apps like Keycloak. Click to apply firewall rules.`;
                    } else if (data.severity === 'low') {
                        banner.classList.add('is-visible');
                        title.textContent = '⚠️ Security Warning';
                        message.textContent = 'Minor security concerns detected. Review the security audit for details.';
                    }
                    // If firewall is active and protecting services, no banner needed
                })
                .catch(error => {
                    console.error('Failed to check security status:', error);
                });
        }

        // Run security check on page load
        window.addEventListener('load', () => {
            checkSecurityStatus();
            // Initialize Lucide icons
            lucide.createIcons();
        });

        // Update dashboard data without page reload
        function updateDashboard() {
            const basePath = getBasePath();
            fetch(`${basePath}/api/dashboard/status`)
                .then(response => response.json())
                .then(data => {
                    updateServiceTable(data.statuses, data.log_stats);
                })
                .catch(error => {
                    console.error('Failed to update dashboard:', error);
                });
        }

        function updateServiceTable(statuses, logStats) {
            const tbody = document.querySelector('table tbody');
            if (!tbody) return;

            // Update each row
            Object.keys(statuses).forEach(serviceName => {
                const status = statuses[serviceName];
                const row = tbody.querySelector(`tr[data-service="${serviceName}"]`);
                if (!row) return; // Service not in table yet, would need full reload

                // Update status text
                const statusText = row.querySelectorAll('.status-text')[0];
                if (statusText) {
                    statusText.className = `status-text status-text--${status.status === 'running' ? 'success' : 'danger'}`;
                    statusText.textContent = status.status;
                }

                // Update health text
                const healthText = row.querySelectorAll('.status-text')[1];
                if (healthText) {
                    let statusClass = 'status-text';
                    if (status.health === 'healthy') statusClass += ' status-text--success';
                    else if (status.health === 'degraded') statusClass += ' status-text--warning';
                    else statusClass += ' status-text--danger';
                    healthText.className = statusClass;
                    healthText.textContent = status.health;
                }

                // Update PID
                const pidCell = row.querySelector('.pid-cell');
                if (pidCell) pidCell.textContent = status.pid || '-';

                // Update CPU
                const cpuCell = row.querySelector('.cpu-cell');
                if (cpuCell) cpuCell.textContent = status.cpu_percent != null ? status.cpu_percent.toFixed(1) + '%' : '-';

                // Update Memory
                const memCell = row.querySelector('.mem-cell');
                if (memCell) memCell.textContent = status.memory_mb != null ? status.memory_mb.toFixed(1) : '-';

                // Update log stats
                const logStatsCell = row.querySelector('.log-stats');
                if (logStatsCell && logStats[serviceName]) {
                    const stats = logStats[serviceName];
                    let html = '';
                    if (stats.ERROR && stats.ERROR > 0) {
                        html += `<span class="status-text status-text--danger">E: ${stats.ERROR}</span> `;
                    }
                    if (stats.WARNING && stats.WARNING > 0) {
                        html += `<span class="status-text status-text--warning">W: ${stats.WARNING}</span> `;
                    }
                    if (stats.INFO && stats.INFO > 0) {
                        html += `<span class="status-text status-text--info">I: ${stats.INFO}</span>`;
                    }
                    logStatsCell.innerHTML = html || '-';
                }

                // Update action icons based on status
                const actionsCell = row.querySelector('.actions-cell');
                if (actionsCell && actionsCell.getAttribute('data-is-admin') === 'true') {
                    if (status.status === 'running') {
                        actionsCell.innerHTML = `
                            <div class="action-icons">
                                <span class="icon-wrapper" data-tooltip="Stop" onclick="controlService('${serviceName}', 'stop')">
                                    <i data-lucide="stop-circle" class="action-icon action-icon--danger"></i>
                                </span>
                                <span class="icon-wrapper" data-tooltip="Restart" onclick="controlService('${serviceName}', 'restart')">
                                    <i data-lucide="refresh-cw" class="action-icon action-icon--neutral"></i>
                                </span>
                            </div>
                        `;
                    } else {
                        actionsCell.innerHTML = `
                            <div class="action-icons">
                                <span class="icon-wrapper" data-tooltip="Start" onclick="controlService('${serviceName}', 'start')">
                                    <i data-lucide="play-circle" class="action-icon action-icon--success"></i>
                                </span>
                            </div>
                        `;
                    }
                    // Re-initialize Lucide icons after updating HTML
                    lucide.createIcons();
                }
            });
        }

        // Poll for updates every 5 seconds
        setInterval(updateDashboard, 5000);
    </script>
</body>
</html>
